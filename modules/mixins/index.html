<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="REvSdOuXsnRcvRVGXVhLRG_6ZFcu3tMz9POkG0Uy1g4" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">

<title>
  
    Mixins &middot; Elixir Recipes
  
</title>
<meta name="description" content="A collection of Elixir programming language solutions to common problems.">
<meta name="keywords" content="modules, behaviour, mixins">
<link rel="stylesheet" href="/css/main.css">





<link rel="canonical" href="http://elixir-recipes.github.io/modules/mixins/">
<link rel="alternate" type="application/rss+xml" title="Elixir Recipes" href="http://elixir-recipes.github.io/feed.xml" />

<!-- Icons -->
<link rel="shortcut icon" href="/images/favicon.ico">
<link rel="icon" href="/images/favicon.ico">
<script>base_url = "";</script>
  </head>
  <body class="">

    <main class="main-container">

        <header class="site-header">

  <div class="container txt-center">
    <a href="#" class="nav-toogle js-menu-trigger sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </a>

    <nav class="js-menu sliding-panel-content">
      <ul>
        <li><a href="/">home</a></li>
        <li><a href="/about">about</a></li>
        <li><a href="/archive">all recipes</a></li>
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i> feed</a></li>
      </ul>
    </nav>
    <div class="js-menu-screen sliding-panel-fade-screen"></div>

    <a href="/" class="author-thumb dot">
      <img src="/images/logo.png" alt=Elixir Recipes class="dot">
    </a>

    
      <h1 class="post-title">Mixins</h1>
      <p class="post-meta">Apr 24, 2016</p>
    

  </div>

</header>


        <section class="main-content">
          <article class="post">
  <div class="post-content container">
    <p>Let’s demystify the frequently used <code class="highlighter-rouge">use</code> keyword in Elixir.</p>

<p>We can use the <code class="highlighter-rouge">use</code> keyword in Elixir to package behaviour and implementation for use in other modules, similar to abstract base classes or mixins in other languages. Mixins reduce the amount of boilerplate in your modules, especially for library authors.</p>

<p>Mixins in Elixir are similar on the surface to <code class="highlighter-rouge">Concerns</code> in Ruby and <code class="highlighter-rouge">Traits</code> in Scala. Before we start, you should be somewhat familiar with <a href="http://elixir-recipes.github.io/modules/behaviours/">behaviours</a> and <a href="http://elixir-recipes.github.io/metaprogramming/macros/">macros</a>.</p>

<h2 id="the-use-keyword">The <code class="highlighter-rouge">use</code> keyword</h2>

<p><code class="highlighter-rouge">use</code> requires the given module and calls the <code class="highlighter-rouge">__using__</code> macro defined for that module. To illustrate, both examples below are equivalent:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">MyModule</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Utils</span><span class="p">,</span> <span class="ss">argument:</span> <span class="ss">:value</span>
<span class="k">end</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">MyModule</span> <span class="k">do</span>
  <span class="kn">require</span> <span class="no">Utils</span>
  <span class="no">Utils</span><span class="o">.</span><span class="n">__using__</span><span class="p">(</span><span class="ss">argument:</span> <span class="ss">:value</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

<h2 id="example">Example</h2>

<p>Now take a look at the <code class="highlighter-rouge">Filter</code> module defined below:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Filter</span> <span class="k">do</span>
   <span class="c1"># Define behaviours which user modules have to implement, with type annotations</span>
   <span class="nv">@callback</span> <span class="n">transform</span><span class="p">(</span><span class="no">String</span><span class="o">.</span><span class="n">t</span><span class="p">)</span> <span class="p">::</span> <span class="no">String</span><span class="o">.</span><span class="n">t</span>

  <span class="c1"># When you call use in your module, the __using__ macro is called.</span>
  <span class="k">defmacro</span> <span class="n">__using__</span><span class="p">(</span><span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span>
      <span class="c1"># User modules must implement the Filter callbacks</span>
      <span class="nv">@behaviour</span> <span class="no">Filter</span>

      <span class="c1"># Define implementation for user modules to use</span>
      <span class="k">def</span> <span class="n">shout</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="sd">"</span><span class="s2">HEY!"</span><span class="p">)</span>
      <span class="k">def</span> <span class="n">greet</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

      <span class="c1"># Defoverridable makes the given functions in the current module overridable</span>
      <span class="c1"># Without defoverridable, new definitions of greet will not be picked up</span>
      <span class="n">defoverridable</span> <span class="p">[</span><span class="ss">shout:</span> <span class="m">0</span><span class="p">,</span> <span class="ss">greet:</span> <span class="m">1</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>First, we define a behaviour callback <code class="highlighter-rouge">transform</code> with the <code class="highlighter-rouge">@callback</code> attribute. Modules that <code class="highlighter-rouge">use</code> the <code class="highlighter-rouge">Filter</code> module will need to implement <code class="highlighter-rouge">transform</code>.</p>

<p>We then define the <code class="highlighter-rouge">__using__</code> macro using <code class="highlighter-rouge">defmacro</code>. <code class="highlighter-rouge">__using__</code> is called whenever the <code class="highlighter-rouge">use</code> keyword is called with this module.</p>

<p>We can accept any <code class="highlighter-rouge">_params</code> specified in the <code class="highlighter-rouge">use</code> call, but we’re not using any for this example.</p>

<p>Within the body of the <code class="highlighter-rouge">__using__</code> macro, we use <code class="highlighter-rouge">quote</code> to return a quoted expression. The execution of this quoted expression is deferred until runtime, when the <code class="highlighter-rouge">use</code> keyword is executed within the user module. This lets us inject code to user modules.</p>

<blockquote>
  <p><a href="http://elixir-lang.org/getting-started/meta/macros.html">Read this</a> if you need a refresher on macros.</p>
</blockquote>

<p>Here we use the <code class="highlighter-rouge">@behaviour</code> attribute to denote that modules that use <code class="highlighter-rouge">Filter</code> must implement the callbacks defined in <code class="highlighter-rouge">Filter</code>.</p>

<p>We define some default concrete implementations of <code class="highlighter-rouge">shout/0</code> and <code class="highlighter-rouge">greet/1</code> which will be injected to user modules. We then use <code class="highlighter-rouge">defoverridable</code> to denote that it can be overriden.</p>

<p>Now let’s take a look at a <code class="highlighter-rouge">MyFilter</code> module which <code class="highlighter-rouge">use</code> the <code class="highlighter-rouge">Filter</code> module:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">MyFilter</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Filter</span>

  <span class="c1"># Override default Filter implementation</span>
  <span class="k">def</span> <span class="n">greet</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="sd">"</span><span class="s2">Sup "</span> <span class="o">&lt;&gt;</span> <span class="n">s</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

<p>In our module we override the <code class="highlighter-rouge">greet/1</code> function with our own implementation.</p>

<blockquote>
  <p>If we didn’t explicitly add <code class="highlighter-rouge">greet/1</code> to our <code class="highlighter-rouge">defoverridable</code>, new definitions of <code class="highlighter-rouge">greet/1</code> will not be picked up and we would use the original definition instead.</p>
</blockquote>

<p>However, compiling the above module gives us the following warning: <code class="highlighter-rouge">warning: undefined behaviour function transform/1 (for behaviour Filter)</code>. This is because we’re missing a required behaviour implementation <code class="highlighter-rouge">transform</code>. Let’s implement all our behaviour callbacks:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">MyFilter</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Filter</span>
  
  <span class="k">def</span> <span class="n">transform</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="n">s</span>

  <span class="c1"># Override default Filter implementation</span>
  <span class="k">def</span> <span class="n">greet</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="sd">"</span><span class="s2">Sup"</span> <span class="o">&lt;&gt;</span> <span class="n">s</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

<p><code class="highlighter-rouge">MyFilter</code> will now compile without warnings. With just a single line of code, we’ve injected <code class="highlighter-rouge">MyFilter</code> with behaviours and default overridable implementation:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="n">iex</span><span class="o">&gt;</span> <span class="no">MyFilter</span><span class="o">.</span><span class="n">transform</span> <span class="sd">"</span><span class="s2">yay"</span>
<span class="n">yay</span>
<span class="ss">:ok</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">MyFilter</span><span class="o">.</span><span class="n">shout</span>
<span class="no">HEY</span><span class="n">!</span>
<span class="ss">:ok</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">MyFilter</span><span class="o">.</span><span class="n">greet</span> <span class="sd">"</span><span class="s2">Yos"</span>
<span class="no">Sup</span> <span class="no">Yos</span>
<span class="ss">:ok</span></code></pre></figure>

<h2 id="other-examples">Other Examples</h2>

<p>If you’ve played around with the OTP, you would have come across <code class="highlighter-rouge">use GenServer</code>. The <a href="http://elixir-lang.org/docs/stable/elixir/GenServer.html"><code class="highlighter-rouge">GenServer</code></a> module uses <code class="highlighter-rouge">use</code> to give developers a set of default client-server functionality which can be overriden. <a href="https://github.com/elixir-lang/elixir/blob/master/lib/elixir/lib/gen_server.ex#L415-L462">Here</a> is an excerpt of its <code class="highlighter-rouge">__using__</code> macro:</p>

<figure class="highlight"><pre><code class="language-elixir" data-lang="elixir">  <span class="k">defmacro</span> <span class="n">__using__</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="ss">location:</span> <span class="ss">:keep</span> <span class="k">do</span>
      <span class="nv">@behaviour</span> <span class="ss">:gen_server</span>

      <span class="nv">@doc</span> <span class="no">false</span>
      <span class="k">def</span> <span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">do</span>
        <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">args</span><span class="p">}</span>
      <span class="k">end</span>

      <span class="nv">@doc</span> <span class="no">false</span>
      <span class="k">def</span> <span class="n">handle_call</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">_from</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
        <span class="c1"># We do this to trick Dialyzer to not complain about non-local returns.</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:bad_call</span><span class="p">,</span> <span class="n">msg</span><span class="p">}</span>
        <span class="k">case</span> <span class="ss">:erlang</span><span class="o">.</span><span class="n">phash2</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span> <span class="k">do</span>
          <span class="m">0</span> <span class="o">-&gt;</span> <span class="k">exit</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
          <span class="m">1</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:stop</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">state</span><span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="nv">@doc</span> <span class="no">false</span>
      <span class="k">def</span> <span class="n">handle_info</span><span class="p">(</span><span class="n">_msg</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
        <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">state</span><span class="p">}</span>
      <span class="k">end</span>

      <span class="nv">@doc</span> <span class="no">false</span>
      <span class="k">def</span> <span class="n">handle_cast</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
        <span class="c1"># We do this to trick Dialyzer to not complain about non-local returns.</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:bad_cast</span><span class="p">,</span> <span class="n">msg</span><span class="p">}</span>
        <span class="k">case</span> <span class="ss">:erlang</span><span class="o">.</span><span class="n">phash2</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span> <span class="k">do</span>
          <span class="m">0</span> <span class="o">-&gt;</span> <span class="k">exit</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
          <span class="m">1</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:stop</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">state</span><span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="nv">@doc</span> <span class="no">false</span>
      <span class="k">def</span> <span class="n">terminate</span><span class="p">(</span><span class="n">_reason</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="k">do</span>
        <span class="ss">:ok</span>
      <span class="k">end</span>

      <span class="nv">@doc</span> <span class="no">false</span>
      <span class="k">def</span> <span class="n">code_change</span><span class="p">(</span><span class="n">_old</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">_extra</span><span class="p">)</span> <span class="k">do</span>
        <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">state</span><span class="p">}</span>
      <span class="k">end</span>

      <span class="n">defoverridable</span> <span class="p">[</span><span class="ss">init:</span> <span class="m">1</span><span class="p">,</span> <span class="ss">handle_call:</span> <span class="m">3</span><span class="p">,</span> <span class="ss">handle_info:</span> <span class="m">2</span><span class="p">,</span>
                      <span class="ss">handle_cast:</span> <span class="m">2</span><span class="p">,</span> <span class="ss">terminate:</span> <span class="m">2</span><span class="p">,</span> <span class="ss">code_change:</span> <span class="m">3</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span></code></pre></figure>

<h2 id="alternatives-to-use">Alternatives to <code class="highlighter-rouge">use</code></h2>

<p>If you don’t need metaprogramming, control over method overriding, nor pass in parameters to your <code class="highlighter-rouge">use</code> call - look into using <a href="http://elixir-lang.org/getting-started/alias-require-and-import.html#import"><code class="highlighter-rouge">import</code></a> instead.</p>

<h2 id="in-closing">In Closing</h2>

<p>Mixins are a powerful way to organize your modules that is well worth its place in your Elixir toolbox. I hope I have helped you dispel the magic of <code class="highlighter-rouge">use</code>. You should have a better understanding on how you can use mixins to inject code into other modules and reduce boilerplate.</p>

  </div>

  <div class="container">
    <aside class="share">

      <span>Share this: </span>

      <a href="http://twitter.com/share?text=Mixins&amp;url=http://elixir-recipes.github.io/modules/mixins/&amp;hashtags=web,dev,blog,soudev&amp;via=nandomoreirame"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <i class="icon icon-twitter-rounded"></i>
      </a>

      <a href="https://www.facebook.com/sharer/sharer.php?u=http://elixir-recipes.github.io/modules/mixins/"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <i class="icon icon-facebook-rounded"></i>
      </a>
    </aside>
  </div>
</article>


<hr>

<aside id="comments" class="disqus">

  <div class="container">
    <h3><i class="icon icon-comments-o"></i> Comments</h3>
    <div id="disqus_thread"></div>

    <script type="text/javascript">
      var disqus_shortname = 'yosriady';
      var disqus_identifier = '/modules/mixins';
      var disqus_title = 'Mixins';
      var disqus_url = 'http://elixir-recipes.github.io';
      /*var disqus_developer = 1;*/

      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>

    <noscript>
      Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
    </noscript>
  </div>

</aside>

        </section>

        
<div class="clearfix"></div>

<footer class="site-footer txt-center">
  <hr>

  <ul class="social">
    
  </ul>

  <small>Made with <i class="icon icon-heart"></i> by <a href="http://yosriady.com" target="_blank">Yos Riady</a> and <a href="https://github.com/Elixir-Recipes/Elixir-Recipes.github.io/graphs/contributors" target="_blank">awesome contributors</a></small>

</footer>


    </main>

    <a href="https://github.com/Elixir-Recipes/elixir-recipes.github.io/tree/source" target="_blank" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#000; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

    <script src="/js/jquery.min.js"></script>
    <script src="/js/jekyll-search.min.js"></script>
    <script src="/js/main.js"></script>
  </body>
</html>
